name: Update README with Promise Hub

on:
  schedule:
    - cron: '0 6 * * *'  # Diariamente Ã s 6h UTC
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch README from Promise Hub
        run: |
          curl -sf -X POST "https://api.promise.codes/api/readme/raw" \
            -H "Content-Type: application/json" \
            -d '{"userId":"${{ secrets.PROMISE_HUB_README_USER_ID }}","token":"${{ secrets.PROMISE_HUB_README_TOKEN }}"}' \
            -o new_readme_content.md

          if [ ! -s new_readme_content.md ]; then
            echo "Failed to fetch README content or empty response"
            exit 1
          fi

      - name: Update README
        run: |
          if grep -q "START_SECTION:promise-hub" README.md; then
            awk '
              /<!--START_SECTION:promise-hub-->/ { print; found=1; next }
              /<!--END_SECTION:promise-hub-->/ {
                while ((getline line < "new_readme_content.md") > 0) print line
                found=0
              }
              !found { print }
            ' README.md > README_updated.md
            mv README_updated.md README.md
          else
            mv new_readme_content.md README.md
          fi
          rm -f new_readme_content.md

      - name: Commit and push
        run: |
          git config user.name "Promise Hub Bot"
          git config user.email "bot@promise-hub.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: update README with latest Promise Hub stats"
            git push
          fi
