name: Update README with Promise Hub

on:
  schedule:
    - cron: '0 6 * * *'  # Diariamente as 6h UTC
  workflow_dispatch:       # Permite executar manualmente

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch README from Promise Hub
        run: |
          curl -sf "${{ secrets.PROMISE_HUB_README_URL }}" -o new_readme_content.md

          if [ ! -s new_readme_content.md ]; then
            echo "Failed to fetch README content or empty response"
            exit 1
          fi

      - name: Update README
        run: |
          # Replace content between markers
          if grep -q "START_SECTION:promise-hub" README.md; then
            # Use awk to replace content between markers
            awk '
              /<!--START_SECTION:promise-hub-->/ { print; found=1; next }
              /<!--END_SECTION:promise-hub-->/ {
                while ((getline line < "new_readme_content.md") > 0) print line
                found=0
              }
              !found { print }
            ' README.md > README_updated.md
            mv README_updated.md README.md
          else
            # No markers found - replace entire README
            mv new_readme_content.md README.md
          fi

          rm -f new_readme_content.md

      - name: Commit and push
        run: |
          git config user.name "Promise Hub Bot"
          git config user.email "bot@promise-hub.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: update README with latest Promise Hub stats"
            git push
          fi
